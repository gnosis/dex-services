version: '3.6'
services:
  mongo:
    image: mongo:latest
    environment:
      - AUTH=no
    restart: always  
    ports:
      - "27017:27017"
    logging:
      driver: "none"
  
  mongoclient:
    image: mongoclient/mongoclient:2.2.0
    environment:
      - MONGOCLIENT_DEFAULT_CONNECTION_URL=mongodb://mongo/dfusion2
    ports:
      - '3000:3000'
    depends_on:
      - mongo
    logging:
      driver: "none"

  ganache-cli:
    ports:
      - '8545:8545'
    image: 'trufflesuite/ganache-cli:latest'
    command: ["-d"]
    logging:
      driver: "none"

  truffle:
    command: /app/run.sh
    build:
      context: .
      dockerfile: docker/truffle/Dockerfile
    depends_on:
      - ganache-cli
    volumes:
      - ./dex-contracts:/app/dex-contracts

  listener:
    command: docker/event_listener/run.sh
    build:
      context: .
      dockerfile: docker/event_listener/Dockerfile
    depends_on:
      - mongo
      - ganache-cli
    volumes:
      - ./:/app/
    environment:
      - SNAPP_CONTRACT_ADDRESS=0xD833215cBcc3f914bD1C9ece3EE7BF8B14f841bb
      - ETHEREUM_NODE_URL=http://ganache-cli:8545

  driver:
    command: cargo run
    build:
      context: .
      dockerfile: docker/driver/Dockerfile
    depends_on:
      - mongo
      - ganache-cli
    restart: always
    volumes:
      # Don't sync target, otherwise we rebuild on every deploy
      - ./driver/src:/app/driver/src
      - ./dex-contracts:/app/dex-contracts
    environment:
      - SNAPP_CONTRACT_ADDRESS=D833215cBcc3f914bD1C9ece3EE7BF8B14f841bb
      - DB_HOST=mongo
      - DB_PORT=27017
      - DB_NAME=dfusion2  
      - RUST_BACKTRACE=1
