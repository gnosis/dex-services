notifications:
  email:
    - oncall-dfusion@gnosis.io
  if: (branch = master) OR (tag IS present)
if: (branch = master) OR (type = pull_request) OR (tag IS present)

os: linux
dist: xenial
language: rust

install:
  - rm -rf /home/travis/.cache/node-gyp
  - rustup component add clippy rustfmt
  - sudo apt-get update && sudo apt-get install -y python-pip && sudo pip install awscli
  - $(aws ecr get-login --no-include-email --region $AWS_REGION)
  - nvm install 10 && nvm alias default 10 && npm install -g yarn@latest && yarn --version
  - (cd dex-contracts && yarn --frozen-lockfile && yarn run prepack)
  - ./scripts/setup_contracts.sh

jobs:
  fast_finish: true
  allow_failures:
    - rust: nightly

  include:
    - name: "Build and Local Testing"
      rust: stable
      cache:
        directories:
          - $HOME/.cache/node-gyp
          - $HOME/.cache/yarn
          - $HOME/.cargo/bin
      before_cache:
        - rm -rf "$TRAVIS_HOME/.cargo/registry/src"
      env: CARGO_INCREMENTAL=0
      script:
        - true

    - name: Coverage
      rust: nightly
      script:
        - curl --location https://github.com/mozilla/grcov/releases/latest/download/grcov-linux-x86_64.tar.bz2 | tar jxf -
        # These flags are recommended by https://github.com/mozilla/grcov#grcov-with-travis .
        # vk: I had to remove `-Zpanic_abort_tests -Cpanic=abort` because this would cause compilation
        # to fail but I haven't investigated more into why.
        # I added `-Awarnings` which allows all warnings. This was necessary because nightly can
        # introduce some new warnings and when testing one such warning appeared in the ethcontract
        # generated contract code which caused the whole file to be printed as part of the warning
        # message which made the build fail (probably travis related).
        - env CARGO_INCREMENTAL=0 RUSTFLAGS="-Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Awarnings" cargo test
        - ./grcov --branch --ignore-not-existing --llvm --ignore "/*" target/debug/ --output-path coveralls.json --output-type "coveralls+" --source-dir . --service-name travis-pro --service-job-id $TRAVIS_JOB_ID 
        - curl --form json_file=@coveralls.json https://coveralls.io/api/v1/jobs
